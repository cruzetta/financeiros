<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Comando Financeiro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Estilos da barra de rolagem para melhor estética */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Transição personalizada para fade-in/out do modal */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        /* Animação personalizada para os cartões KPI */
        @keyframes pulse-bg {
            0%, 100% { background-color: #3b82f6; }
            50% { background-color: #60a5fa; }
        }
        .pulse-update {
            animation: pulse-bg 0.7s ease-out;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #60a5fa;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Container Principal da Aplicação -->
    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <!-- Cabeçalho -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2 pt-8">Centro de Comando</h1>
            <div class="flex items-center justify-center space-x-4 mt-4">
                <button id="prev-period-btn" class="p-2 rounded-md bg-gray-700 hover:bg-gray-600 transition-colors">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <h2 id="period-display" class="text-lg md:text-xl font-semibold text-blue-400 w-72 text-center"></h2>
                <button id="next-period-btn" class="p-2 rounded-md bg-gray-700 hover:bg-gray-600 transition-colors">
                    <i data-lucide="chevron-right" class="w-6 h-6"></i>
                </button>
            </div>
        </header>

        <!-- Navegação por Abas -->
        <nav class="mb-8 border-b border-gray-700">
            <div class="flex justify-center space-x-8">
                <button id="tab-dashboard" class="tab-button text-lg font-medium py-3 border-b-2 border-transparent transition-colors">Financeiro</button>
                <button id="tab-consultoria" class="tab-button text-lg font-medium py-3 border-b-2 border-transparent transition-colors">Consultoria</button>
            </div>
        </nav>

        <!-- Área de Conteúdo Principal -->
        <main id="main-content">
            <!-- Visão do Dashboard -->
            <div id="view-dashboard">
                <!-- Dashboard de KPIs -->
                <section id="kpi-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
                    <!-- KPIs serão injetados aqui pelo JS -->
                </section>

                <!-- Atalhos e Ações -->
                <section class="mb-8">
                    <div class="flex flex-col md:flex-row gap-8">
                        <!-- Atalhos -->
                        <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div id="revenue-shortcuts-section">
                                <h3 class="text-xl font-bold mb-4 text-green-400 flex items-center"><i data-lucide="trending-up" class="mr-2"></i>Atalhos de Receita</h3>
                                <div id="revenue-shortcuts" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                            </div>
                            <div id="expense-shortcuts-section">
                                <h3 class="text-xl font-bold mb-4 text-red-400 flex items-center"><i data-lucide="trending-down" class="mr-2"></i>Atalhos de Despesa</h3>
                                <div id="expense-shortcuts" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                            </div>
                        </div>
                    </div>
                     <div class="mt-6 flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="add-shortcut-btn" class="flex-1 w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center space-x-2">
                            <i data-lucide="star" class="w-5 h-5"></i>
                            <span>Novo Atalho</span>
                        </button>
                        <button id="add-transaction-btn" class="flex-1 w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center space-x-2">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>
                            <span>Nova Transação</span>
                        </button>
                    </div>
                </section>

                <!-- Lista de Transações -->
                <section class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-xl">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="text-2xl font-bold text-white">Transações do Período</h3>
                        <div class="relative w-full sm:w-64">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="search-input" placeholder="Buscar por descrição..." class="w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div id="transactions-list" class="overflow-x-auto">
                        <!-- Lista de transações será injetada aqui -->
                    </div>
                </section>
            </div>

            <!-- Visão de Consultoria -->
            <div id="view-consultoria" class="hidden">
                 <!-- Visão da Lista de Clientes -->
                <div id="client-list-view">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-white">Clientes</h2>
                        <button id="add-client-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 transition-colors">
                            <i data-lucide="user-plus"></i>
                            <span>Novo Cliente</span>
                        </button>
                    </div>
                    <div id="client-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Cartões de clientes serão injetados aqui -->
                    </div>
                </div>

                <!-- Visão de Detalhe do Abate -->
                <div id="slaughter-detail-view" class="hidden">
                    <header class="mb-6">
                        <button id="back-to-clients-btn" class="text-blue-400 hover:text-blue-300 mb-4 flex items-center space-x-2">
                            <i data-lucide="arrow-left"></i>
                            <span>Voltar para Clientes</span>
                        </button>
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 id="slaughter-client-name" class="text-3xl font-bold text-white"></h2>
                                <p id="slaughter-client-rate" class="text-gray-400"></p>
                            </div>
                            <button id="add-slaughter-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 transition-colors">
                                <i data-lucide="plus"></i>
                                <span>Novo Abate</span>
                            </button>
                        </div>
                    </header>
                    <section id="slaughter-list-container" class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-xl">
                         <!-- Lista de abates será injetada aqui -->
                    </section>
                </div>
            </div>
        </main>
    </div>

    <!-- Container de Modais -->
    <div id="modals">
        <!-- Modal de Transação -->
        <div id="transaction-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md relative">
                <button class="close-modal-btn absolute top-3 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <h2 id="transaction-modal-title" class="text-2xl font-bold mb-6 text-center">Nova Transação</h2>
                <form id="transaction-form">
                    <input type="hidden" id="transaction-id" name="transaction-id">
                    <input type="hidden" id="transaction-shortcut-id" name="transaction-shortcut-id">
                    <div class="mb-4">
                        <label for="transaction-description" class="block mb-2 text-sm font-medium text-gray-300">Descrição</label>
                        <input type="text" id="transaction-description" name="transaction-description" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="transaction-amount" class="block mb-2 text-sm font-medium text-gray-300">Valor (R$)</label>
                            <input type="number" step="0.01" id="transaction-amount" name="transaction-amount" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="transaction-due-date" class="block mb-2 text-sm font-medium text-gray-300">Vencimento</label>
                            <input type="date" id="transaction-due-date" name="transaction-due-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                             <label for="transaction-type" class="block mb-2 text-sm font-medium text-gray-300">Tipo</label>
                             <select id="transaction-type" name="transaction-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                 <option value="expense">Despesa</option>
                                 <option value="revenue">Receita</option>
                             </select>
                        </div>
                        <div>
                            <label for="transaction-status" class="block mb-2 text-sm font-medium text-gray-300">Status</label>
                            <select id="transaction-status" name="transaction-status" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="pending">A Pagar/Receber</option>
                                <option value="paid">Pago/Recebido</option>
                            </select>
                        </div>
                    </div>
                    <div id="installments-section" class="mb-6">
                        <label for="transaction-installments" class="block mb-2 text-sm font-medium text-gray-300">Parcelas (1 = à vista)</label>
                        <input type="number" min="1" id="transaction-installments" name="transaction-installments" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" value="1">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">Salvar Transação</button>
                </form>
            </div>
        </div>

        <!-- Modal de Atalho -->
        <div id="shortcut-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md relative">
                <button class="close-modal-btn absolute top-3 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <h2 id="shortcut-modal-title" class="text-2xl font-bold mb-6 text-center">Novo Atalho</h2>
                <form id="shortcut-form">
                    <input type="hidden" id="shortcut-id" name="shortcut-id">
                    <div class="mb-4">
                        <label for="shortcut-name" class="block mb-2 text-sm font-medium text-gray-300">Nome do Atalho</label>
                        <input type="text" id="shortcut-name" name="shortcut-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="shortcut-type" class="block mb-2 text-sm font-medium text-gray-300">Tipo</label>
                            <select id="shortcut-type" name="shortcut-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="expense">Despesa</option>
                                <option value="revenue">Receita</option>
                            </select>
                        </div>
                        <div>
                             <label for="shortcut-frequency" class="block mb-2 text-sm font-medium text-gray-300">Frequência</label>
                             <select id="shortcut-frequency" name="shortcut-frequency" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                 <option value="variable">Variável</option>
                                 <option value="fixed">Fixa (Mensal)</option>
                             </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="shortcut-value" class="block mb-2 text-sm font-medium text-gray-300">Valor Padrão (R$)</label>
                            <input type="number" step="0.01" id="shortcut-value" name="shortcut-value" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div id="shortcut-due-day-section" class="hidden">
                             <label for="shortcut-due-day" class="block mb-2 text-sm font-medium text-gray-300">Dia do Vencimento</label>
                            <input type="number" id="shortcut-due-day" name="shortcut-due-day" min="1" max="28" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div id="shortcut-effective-date-section" class="mb-4 hidden">
                        <label for="shortcut-effective-date" class="block mb-2 text-sm font-medium text-gray-300">Aplicar alteração a partir de:</label>
                        <input type="date" id="shortcut-effective-date" name="shortcut-effective-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label class="block mb-2 text-sm font-medium text-gray-300">Ícone</label>
                        <div id="shortcut-icon-selection" class="grid grid-cols-6 gap-2 bg-gray-700 p-2 rounded-lg">
                           <!-- Ícones serão injetados aqui -->
                        </div>
                        <input type="hidden" id="shortcut-icon" name="shortcut-icon" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-colors">Salvar Atalho</button>
                </form>
            </div>
        </div>

        <!-- Modal de Cliente -->
        <div id="client-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md relative">
                <button class="close-modal-btn absolute top-3 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <h2 id="client-modal-title" class="text-2xl font-bold mb-6 text-center">Novo Cliente</h2>
                <form id="client-form">
                    <input type="hidden" id="client-id" name="client-id">
                    <div class="mb-4">
                        <label for="client-name" class="block mb-2 text-sm font-medium text-gray-300">Nome do Cliente</label>
                        <input type="text" id="client-name" name="client-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="client-rate" class="block mb-2 text-sm font-medium text-gray-300">Valor por Cabeça (R$)</label>
                        <input type="number" step="0.01" id="client-rate" name="client-rate" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors">Salvar Cliente</button>
                </form>
            </div>
        </div>

        <!-- Modal de Abate -->
        <div id="slaughter-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md relative">
                <button class="close-modal-btn absolute top-3 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <h2 id="slaughter-modal-title" class="text-2xl font-bold mb-6 text-center">Novo Abate</h2>
                <form id="slaughter-form">
                    <input type="hidden" id="slaughter-id" name="slaughter-id">
                    <input type="hidden" id="slaughter-client-id" name="slaughter-client-id">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                             <label for="slaughter-date" class="block mb-2 text-sm font-medium text-gray-300">Data do Abate</label>
                            <input type="date" id="slaughter-date" name="slaughter-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="slaughter-heads" class="block mb-2 text-sm font-medium text-gray-300">Nº de Cabeças</label>
                            <input type="number" id="slaughter-heads" name="slaughter-heads" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                         <div>
                            <label for="slaughter-revenue-travel" class="block mb-2 text-sm font-medium text-gray-300">Receita Desloc. (R$)</label>
                            <input type="number" step="0.01" id="slaughter-revenue-travel" name="slaughter-revenue-travel" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="slaughter-cost-travel" class="block mb-2 text-sm font-medium text-gray-300">Custo Desloc. (R$)</label>
                            <input type="number" step="0.01" id="slaughter-cost-travel" name="slaughter-cost-travel" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                     <div class="mb-6">
                        <label for="slaughter-cost-daily" class="block mb-2 text-sm font-medium text-gray-300">Custo Diarista (R$)</label>
                        <input type="number" step="0.01" id="slaughter-cost-daily" name="slaughter-cost-daily" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">Salvar Abate</button>
                </form>
            </div>
        </div>
        
        <!-- Modal de Confirmação -->
        <div id="confirmation-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md text-center">
                <div id="confirmation-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-200 mb-4">
                  <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <h3 id="confirmation-title" class="text-lg font-medium leading-6 text-white mb-2">Confirmar Ação</h3>
                <div class="mt-2 text-sm text-gray-400">
                  <p id="confirmation-message">Você tem certeza que deseja continuar?</p>
                </div>
                <div id="confirmation-buttons" class="mt-6 flex flex-col sm:flex-row justify-center gap-4">
                  <!-- Botões são inseridos dinamicamente aqui -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Relógio Fixo -->
    <div id="fixed-clock" class="fixed bottom-4 right-4 bg-gray-700 text-white text-sm font-mono py-2 px-4 rounded-lg shadow-lg flex items-center space-x-2 z-50">
        <i data-lucide="clock" class="w-4 h-4"></i>
        <span id="clock-display"></span>
    </div>


    <!-- SEÇÃO DE SCRIPTS -->
    <script type="module">
        // --- OBJETO PRINCIPAL DA APLICAÇÃO ---
        const App = {
            isInitialized: false,
            // --- GERENCIAMENTO DE ESTADO ---
            state: {
                currentView: 'dashboard', // 'dashboard', 'consultoria-list', 'consultoria-detail'
                currentClientId: null,
                currentDateForPeriod: new Date(),
                transactions: [],
                shortcuts: [],
                clients: [],
                slaughters: [],
                filterText: '',
            },

            // --- ELEMENTOS DO DOM ---
            elements: {
                periodDisplay: document.getElementById('period-display'),
                prevPeriodBtn: document.getElementById('prev-period-btn'),
                nextPeriodBtn: document.getElementById('next-period-btn'),
                kpiDashboard: document.getElementById('kpi-dashboard'),
                revenueShortcuts: document.getElementById('revenue-shortcuts'),
                expenseShortcuts: document.getElementById('expense-shortcuts'),
                transactionsList: document.getElementById('transactions-list'),
                searchInput: document.getElementById('search-input'),
                clockDisplay: document.getElementById('clock-display'),
                
                // Visões e Abas
                viewDashboard: document.getElementById('view-dashboard'),
                viewConsultoria: document.getElementById('view-consultoria'),
                tabDashboard: document.getElementById('tab-dashboard'),
                tabConsultoria: document.getElementById('tab-consultoria'),

                // Elementos de Consultoria
                clientListView: document.getElementById('client-list-view'),
                slaughterDetailView: document.getElementById('slaughter-detail-view'),
                clientListContainer: document.getElementById('client-list-container'),
                slaughterClientName: document.getElementById('slaughter-client-name'),
                slaughterClientRate: document.getElementById('slaughter-client-rate'),
                slaughterListContainer: document.getElementById('slaughter-list-container'),
                
                // Modais e Formulários
                transactionModal: document.getElementById('transaction-modal'),
                transactionForm: document.getElementById('transaction-form'),
                transactionModalTitle: document.getElementById('transaction-modal-title'),
                installmentsSection: document.getElementById('installments-section'),
                shortcutModal: document.getElementById('shortcut-modal'),
                shortcutForm: document.getElementById('shortcut-form'),
                shortcutModalTitle: document.getElementById('shortcut-modal-title'),
                iconSelection: document.getElementById('shortcut-icon-selection'),
                shortcutDueDaySection: document.getElementById('shortcut-due-day-section'),
                shortcutEffectiveDateSection: document.getElementById('shortcut-effective-date-section'),
                clientModal: document.getElementById('client-modal'),
                clientForm: document.getElementById('client-form'),
                clientModalTitle: document.getElementById('client-modal-title'),
                slaughterModal: document.getElementById('slaughter-modal'),
                slaughterForm: document.getElementById('slaughter-form'),
                slaughterModalTitle: document.getElementById('slaughter-modal-title'),

                // Elementos de Modal Genéricos
                confirmationModal: document.getElementById('confirmation-modal'),
                confirmationTitle: document.getElementById('confirmation-title'),
                confirmationMessage: document.getElementById('confirmation-message'),
                confirmationButtons: document.getElementById('confirmation-buttons'),
                confirmationIcon: document.getElementById('confirmation-icon'),
            },
            
            // --- CONSTANTES ---
            iconList: ['landmark', 'shopping-cart', 'utensils-crossed', 'home', 'car', 'heart-pulse', 'graduation-cap', 'plane', 'briefcase', 'gift', 'paw-print', 'receipt', 'piggy-bank', 'scale', 'banknote', 'coins', 'credit-card', 'wallet', 'wrench', 'building', 'truck', 'sprout'],

            // --- INICIALIZAÇÃO ---
            init() {
                // Previne re-inicialização
                if (this.isInitialized) {
                    this.updateUI(); // Apenas atualiza a UI se já estiver inicializado
                    return;
                }
                this.isInitialized = true;
                
                this.loadData();
                this.setupEventListeners();
                this.switchView('dashboard');
                this.startClock();
                lucide.createIcons();
            },

            // --- LÓGICA DO RELÓGIO ---
            startClock() {
                const update = () => {
                    const now = new Date();
                    const date = now.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const time = now.toLocaleTimeString('pt-BR');
                    if (this.elements.clockDisplay) {
                       this.elements.clockDisplay.textContent = `${date} ${time}`;
                    }
                };
                update(); 
                setInterval(update, 1000); 
            },

            // --- PERSISTÊNCIA DE DADOS (localStorage) ---
            loadData() {
                const userId = 'local_user'; // Chave estática para armazenamento local
                this.state.transactions = JSON.parse(localStorage.getItem(`financeCenter_transactions_${userId}`)) || [];
                this.state.shortcuts = JSON.parse(localStorage.getItem(`financeCenter_shortcuts_${userId}`)) || [];
                this.state.clients = JSON.parse(localStorage.getItem(`financeCenter_clients_${userId}`)) || [];
                this.state.slaughters = JSON.parse(localStorage.getItem(`financeCenter_slaughters_${userId}`)) || [];

                this.state.transactions.forEach(t => t.dueDate = new Date(t.dueDate));
                this.state.slaughters.forEach(s => s.date = new Date(s.date));
                this.state.shortcuts.forEach(s => { if (s.createdAt) s.createdAt = new Date(s.createdAt); });
            },

            saveData() {
                const userId = 'local_user'; // Chave estática para armazenamento local
                localStorage.setItem(`financeCenter_transactions_${userId}`, JSON.stringify(this.state.transactions));
                localStorage.setItem(`financeCenter_shortcuts_${userId}`, JSON.stringify(this.state.shortcuts));
                localStorage.setItem(`financeCenter_clients_${userId}`, JSON.stringify(this.state.clients));
                localStorage.setItem(`financeCenter_slaughters_${userId}`, JSON.stringify(this.state.slaughters));
            },
            
            // --- GERENCIAMENTO DE UI E VISÕES ---
            updateUI() {
                // Esta função agora é mais simples, apenas renderiza o estado atual.
                // O saldo e as transações fixas são tratados por funções dedicadas quando necessário.
                this.generateFixedTransactionsForCurrentPeriod();
                this.updateBalanceTransactionForPeriod(this.state.currentDateForPeriod);

                // Renderiza com base na visão ativa atual
                switch (this.state.currentView) {
                    case 'dashboard':
                        this.renderPeriodDisplay();
                        this.renderKPIs();
                        this.renderShortcuts();
                        this.renderTransactions();
                        break;
                    case 'consultoria-list':
                        this.renderClientList();
                        break;
                    case 'consultoria-detail':
                         this.renderPeriodDisplay();
                        this.renderSlaughterDetail();
                        break;
                }
                lucide.createIcons();
            },
            
            switchView(view, clientId = null) {
                this.state.currentView = view;
                this.state.currentClientId = clientId;

                // Oculta todas as visões principais
                this.elements.viewDashboard.classList.add('hidden');
                this.elements.viewConsultoria.classList.add('hidden');
                this.elements.clientListView.classList.add('hidden');
                this.elements.slaughterDetailView.classList.add('hidden');

                // Desativa todas as abas
                this.elements.tabDashboard.classList.remove('active');
                this.elements.tabConsultoria.classList.remove('active');

                switch (view) {
                    case 'dashboard':
                        this.elements.viewDashboard.classList.remove('hidden');
                        this.elements.tabDashboard.classList.add('active');
                        break;
                    case 'consultoria-list':
                        this.elements.viewConsultoria.classList.remove('hidden');
                        this.elements.clientListView.classList.remove('hidden');
                         this.elements.tabConsultoria.classList.add('active');
                        break;
                    case 'consultoria-detail':
                         this.elements.viewConsultoria.classList.remove('hidden');
                        this.elements.slaughterDetailView.classList.remove('hidden');
                        this.elements.tabConsultoria.classList.add('active');
                        break;
                }
                this.updateUI();
            },

            // --- LÓGICA DE PERÍODO ---
            getPeriod(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const start = new Date(year, month, 1, 0, 0, 0, 0);
                const end = new Date(year, month + 1, 0, 23, 59, 59, 999);
                return { start, end };
            },
            
            changePeriod(months) {
                this.state.currentDateForPeriod.setMonth(this.state.currentDateForPeriod.getMonth() + months);
                this.updateUI();
            },
            
            renderPeriodDisplay() {
                const period = this.getPeriod(this.state.currentDateForPeriod);
                this.elements.periodDisplay.textContent = `${period.start.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
            },

            // --- RENDERIZAÇÃO DE KPIs ---
            renderKPIs() {
                const period = this.getPeriod(this.state.currentDateForPeriod);
                const transactionsInPeriod = this.state.transactions.filter(t => t.dueDate >= period.start && t.dueDate <= period.end);
                
                // Calcula as despesas vencidas de todos os meses anteriores
                const overdueExpenses = this.state.transactions.filter(t => 
                    t.dueDate < period.start && 
                    t.status === 'pending' &&
                    t.type === 'expense'
                ).reduce((sum, t) => sum + t.amount, 0);

                const received = transactionsInPeriod.filter(t => t.type === 'revenue' && t.status === 'paid').reduce((sum, t) => sum + t.amount, 0);
                const paid = transactionsInPeriod.filter(t => t.type === 'expense' && t.status === 'paid').reduce((sum, t) => sum + t.amount, 0);
                const toReceive = transactionsInPeriod.filter(t => t.type === 'revenue' && t.status === 'pending').reduce((sum, t) => sum + t.amount, 0);
                const toPayCurrentMonth = transactionsInPeriod.filter(t => t.type === 'expense' && t.status === 'pending').reduce((sum, t) => sum + t.amount, 0);
                
                const currentBalance = received - paid;
                // O saldo projetado deve considerar as despesas vencidas
                const projectedBalance = currentBalance + toReceive - (toPayCurrentMonth + overdueExpenses);

                const kpis = [
                    { label: 'Recebido', value: received, color: 'green', icon: 'arrow-down-circle' },
                    { label: 'Pago', value: paid, color: 'red', icon: 'arrow-up-circle' },
                    { label: 'Saldo Atual', value: currentBalance, color: 'blue', icon: 'scale' },
                    { label: 'A Receber', value: toReceive, color: 'green', icon: 'calendar-plus' },
                    { label: 'A Pagar', value: toPayCurrentMonth, overdueValue: overdueExpenses, color: 'red', icon: 'calendar-minus' },
                    { label: 'Saldo Previsto', value: projectedBalance, color: 'blue', icon: 'bar-chart-2' },
                ];

                this.elements.kpiDashboard.innerHTML = kpis.map(kpi => {
                    let valueHtml = `<p class="text-2xl font-bold text-white">${this.formatCurrency(kpi.value)}</p>`;
                    
                    // Exibição personalizada para o KPI "A Pagar"
                    if (kpi.label === 'A Pagar' && kpi.overdueValue > 0) {
                        valueHtml = `
                            <p class="text-2xl font-bold text-white" title="No mês: ${this.formatCurrency(kpi.value)} | Atrasado: ${this.formatCurrency(kpi.overdueValue)}">
                                ${this.formatCurrency(kpi.value)} 
                                <span class="text-base font-medium text-red-400">(+${this.formatCurrency(kpi.overdueValue)})</span>
                            </p>
                        `;
                    }

                    return `
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105" id="kpi-${kpi.label.replace(' ', '-')}">
                            <div class="p-3 rounded-full bg-${kpi.color}-500 bg-opacity-20 text-${kpi.color}-400">
                                <i data-lucide="${kpi.icon}" class="w-7 h-7"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">${kpi.label}</p>
                                ${valueHtml}
                            </div>
                        </div>
                    `
                }).join('');
            },

            // --- RENDERIZAÇÃO DE ATALHOS E TRANSAÇÕES ---
            renderShortcuts() {
                this.elements.revenueShortcuts.innerHTML = '';
                this.elements.expenseShortcuts.innerHTML = '';
                const period = this.getPeriod(this.state.currentDateForPeriod);
                this.state.shortcuts.forEach(shortcut => {
                    let displayValue = this.formatCurrency(shortcut.defaultValue);
                    if (shortcut.frequency === 'variable') {
                        const accumulated = this.state.transactions
                            .filter(t => t.shortcutId === shortcut.id && t.dueDate >= period.start && t.dueDate <= period.end)
                            .reduce((sum, t) => sum + t.amount, 0);
                        displayValue = this.formatCurrency(accumulated);
                    }
                    const shortcutCard = `
                        <div data-shortcut-id="${shortcut.id}" class="shortcut-card bg-gray-700 p-3 rounded-lg flex flex-col items-center justify-center text-center cursor-pointer hover:bg-gray-600 transition-colors relative group">
                            <div class="absolute top-1 right-1 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="edit-shortcut-btn p-1 rounded-full bg-gray-800 hover:bg-blue-600" data-id="${shortcut.id}"><i data-lucide="edit-2" class="w-3 h-3 pointer-events-none"></i></button>
                                <button class="delete-shortcut-btn p-1 rounded-full bg-gray-800 hover:bg-red-600" data-id="${shortcut.id}"><i data-lucide="trash-2" class="w-3 h-3 pointer-events-none"></i></button>
                            </div>
                            <i data-lucide="${shortcut.icon}" class="w-8 h-8 mb-2 ${shortcut.type === 'revenue' ? 'text-green-400' : 'text-red-400'}"></i>
                            <p class="text-sm font-medium truncate w-full" title="${shortcut.name}">${shortcut.name}</p>
                            <p class="text-xs text-gray-400">${displayValue}</p>
                        </div>`;
                    if (shortcut.type === 'revenue') {
                        this.elements.revenueShortcuts.innerHTML += shortcutCard;
                    } else {
                        this.elements.expenseShortcuts.innerHTML += shortcutCard;
                    }
                });
            },

            renderTransactions() {
                const period = this.getPeriod(this.state.currentDateForPeriod);
                let transactionsToRender = this.state.transactions
                    .filter(t => t.dueDate >= period.start && t.dueDate <= period.end)
                    .filter(t => t.description.toLowerCase().includes(this.state.filterText.toLowerCase()));
                transactionsToRender.sort((a, b) => {
                    if (a.isBalanceTransfer) return -1; // Mantém a transferência de saldo no topo
                    if (b.isBalanceTransfer) return 1;
                    return a.dueDate - b.dueDate;
                });


                if (transactionsToRender.length === 0) {
                    this.elements.transactionsList.innerHTML = `<div class="text-center py-8 text-gray-500"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i><p>Nenhuma transação neste período.</p></div>`;
                } else {
                    this.elements.transactionsList.innerHTML = `
                        <div class="hidden md:grid grid-cols-12 gap-4 font-bold p-2 text-gray-400 text-sm">
                            <div class="col-span-1"></div><div class="col-span-4">Descrição</div><div class="col-span-2 text-right">Valor</div><div class="col-span-2 text-center">Vencimento</div><div class="col-span-1 text-center">Tipo</div><div class="col-span-2 text-right">Ações</div>
                        </div>
                        ${transactionsToRender.map(t => this.createTransactionRow(t)).join('')}`;
                }
                lucide.createIcons();
            },
            
            createTransactionRow(t) {
                const isPaid = t.status === 'paid';
                const typeColor = t.type === 'revenue' ? 'text-green-400' : 'text-red-400';
                const descriptionClass = isPaid ? 'line-through text-gray-500' : 'text-gray-200';
                const valueClass = isPaid ? 'line-through text-gray-500' : typeColor;
                
                const isAutoTransfer = t.isBalanceTransfer === true;

                const actionButtonsHTML = isAutoTransfer
                    ? `<div class="flex items-center justify-end pr-2" title="Transação automática de saldo"><i data-lucide="lock" class="w-5 h-5 text-gray-500"></i></div>`
                    : `<button class="edit-transaction-btn p-2 text-gray-400 hover:text-blue-400 rounded-full hover:bg-gray-600 transition-colors" data-id="${t.id}"><i data-lucide="edit-2" class="w-4 h-4 pointer-events-none"></i></button>
                       <button class="delete-transaction-btn p-2 text-gray-400 hover:text-red-400 rounded-full hover:bg-gray-600 transition-colors" data-id="${t.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>`;

                return `
                    <div class="grid grid-cols-2 md:grid-cols-12 gap-4 items-center p-3 rounded-lg ${isAutoTransfer ? 'bg-gray-800/50' : 'hover:bg-gray-700/50'} border-b border-gray-700 last:border-b-0">
                        <div class="md:col-span-1 flex items-center justify-start">
                            <input type="checkbox" data-id="${t.id}" class="transaction-status-check h-5 w-5 rounded bg-gray-600 border-gray-500 text-blue-500 focus:ring-blue-600 cursor-pointer" 
                            ${isPaid ? 'checked' : ''} 
                            ${isAutoTransfer ? 'disabled' : ''}>
                        </div>
                        <div class="md:col-span-4 flex items-center space-x-2"><span class="md:hidden font-bold text-gray-400">Desc:</span><p class="${descriptionClass} font-medium">${t.description}</p></div>
                        <div class="md:col-span-2 flex justify-between md:justify-end items-center"><span class="md:hidden font-bold text-gray-400">Valor:</span><p class="${valueClass} font-bold text-right">${this.formatCurrency(t.amount)}</p></div>
                        <div class="md:col-span-2 flex justify-between md:justify-center items-center"><span class="md:hidden font-bold text-gray-400">Venc:</span><p class="text-gray-400 text-sm text-center">${t.dueDate.toLocaleDateString('pt-BR')}</p></div>
                        <div class="md:col-span-1 flex justify-between md:justify-center items-center"><span class="md:hidden font-bold text-gray-400">Tipo:</span><i data-lucide="${t.type === 'revenue' ? 'arrow-down' : 'arrow-up'}" class="${typeColor} w-5 h-5"></i></div>
                        <div class="col-span-2 md:col-span-2 flex justify-end items-center space-x-2">
                            ${actionButtonsHTML}
                        </div>
                    </div>`;
            },
            
            // --- LISTENERS DE EVENTOS ---
            setupEventListeners() {
                // Navegação principal
                this.elements.prevPeriodBtn.addEventListener('click', () => this.changePeriod(-1));
                this.elements.nextPeriodBtn.addEventListener('click', () => this.changePeriod(1));
                this.elements.searchInput.addEventListener('input', e => { this.state.filterText = e.target.value; this.renderTransactions(); });
                
                // Navegação por abas
                this.elements.tabDashboard.addEventListener('click', () => this.switchView('dashboard'));
                this.elements.tabConsultoria.addEventListener('click', () => this.switchView('consultoria-list'));

                // Botões do modal
                document.getElementById('add-transaction-btn').addEventListener('click', () => this.openTransactionModal());
                document.getElementById('add-shortcut-btn').addEventListener('click', () => this.openShortcutModal());
                document.getElementById('add-client-btn').addEventListener('click', () => this.openClientModal());
                document.getElementById('add-slaughter-btn').addEventListener('click', () => this.openSlaughterModal());
                document.getElementById('back-to-clients-btn').addEventListener('click', () => this.switchView('consultoria-list'));
                
                document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => this.closeAllModals()));
                
                // Envios de formulário
                this.elements.transactionForm.addEventListener('submit', e => this.handleTransactionFormSubmit(e));
                this.elements.shortcutForm.addEventListener('submit', e => this.handleShortcutFormSubmit(e));
                this.elements.clientForm.addEventListener('submit', e => this.handleClientFormSubmit(e));
                this.elements.slaughterForm.addEventListener('submit', e => this.handleSlaughterFormSubmit(e));

                this.elements.shortcutForm.elements['shortcut-frequency'].addEventListener('change', e => {
                    if (e.target.value === 'fixed') {
                        this.elements.shortcutDueDaySection.classList.remove('hidden');
                    } else {
                        this.elements.shortcutDueDaySection.classList.add('hidden');
                    }
                });

                // Delegação de eventos para elementos dinâmicos
                document.body.addEventListener('click', e => {
                    const button = e.target.closest('button, .shortcut-card');
                    if (!button) return;
                    const id = button.dataset.id;
                    
                    // Ações de atalho
                    if (button.matches('.edit-shortcut-btn')) this.openShortcutModal(id);
                    if (button.matches('.delete-shortcut-btn')) this.confirmDeleteShortcut(id);
                    if (button.matches('.shortcut-card')) this.openTransactionModal(null, button.dataset.shortcutId);

                    // Ações de transação
                    if (button.matches('.edit-transaction-btn')) this.openTransactionModal(id);
                    if (button.matches('.delete-transaction-btn')) this.confirmDeleteTransaction(id);

                     // Ações de cliente
                    if (button.matches('.edit-client-btn')) this.openClientModal(id);
                    if (button.matches('.view-slaughters-btn')) this.switchView('consultoria-detail', id);
                    
                    // Ações de abate
                    if (button.matches('.edit-slaughter-btn')) this.openSlaughterModal(id);
                    if (button.matches('.delete-slaughter-btn')) this.confirmDeleteSlaughter(id);
                });
                
                document.body.addEventListener('change', e => { 
                    if (e.target.matches('.transaction-status-check')) {
                         const id = e.target.dataset.id;
                         const isPaid = e.target.checked;
                         const transaction = this.state.transactions.find(t => t.id === id);
                         if (transaction) {
                            this.toggleTransactionStatus(id, isPaid, transaction.dueDate);
                         }
                    }
                });
                
                this.elements.iconSelection.addEventListener('click', e => {
                    const iconButton = e.target.closest('.icon-btn');
                    if (iconButton) {
                        document.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('ring-2', 'ring-blue-500'));
                        iconButton.classList.add('ring-2', 'ring-blue-500');
                        document.getElementById('shortcut-icon').value = iconButton.dataset.icon;
                    }
                });
            },

            // --- LÓGICA DE MODAL E FORMULÁRIO ---
            openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); },
            closeAllModals() { document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden')); },

            openTransactionModal(id = null, shortcutId = null) {
                const form = this.elements.transactionForm;
                form.reset();
                form.elements['transaction-id'].value = '';
                this.elements.installmentsSection.style.display = 'block';

                if (id) {
                    const transaction = this.state.transactions.find(t => t.id === id); if (!transaction) return;
                    this.elements.transactionModalTitle.textContent = 'Editar Transação';
                    form.elements['transaction-id'].value = transaction.id;
                    form.elements['transaction-description'].value = transaction.description;
                    form.elements['transaction-amount'].value = transaction.amount;
                    form.elements['transaction-due-date'].value = this.formatDateForInput(transaction.dueDate);
                    form.elements['transaction-type'].value = transaction.type;
                    form.elements['transaction-status'].value = transaction.status;
                    form.elements['transaction-shortcut-id'].value = transaction.shortcutId || '';
                    this.elements.installmentsSection.style.display = 'none';
                } else if (shortcutId) {
                    const shortcut = this.state.shortcuts.find(s => s.id === shortcutId); if (!shortcut) return;
                    this.elements.transactionModalTitle.textContent = `Lançar: ${shortcut.name}`;
                    form.elements['transaction-description'].value = shortcut.name;
                    form.elements['transaction-amount'].value = shortcut.defaultValue;
                    form.elements['transaction-type'].value = shortcut.type;
                    form.elements['transaction-due-date'].value = this.formatDateForInput(new Date());
                    form.elements['transaction-shortcut-id'].value = shortcut.id;
                } else {
                    this.elements.transactionModalTitle.textContent = 'Nova Transação';
                    form.elements['transaction-due-date'].value = this.formatDateForInput(new Date());
                }
                this.openModal('transaction-modal');
            },

            handleTransactionFormSubmit(e) {
                e.preventDefault();
                const form = e.target.elements;
                const dueDateValue = form['transaction-due-date'].value;
                if (!dueDateValue) {
                    this.showMessage('Erro de Validação', 'O campo de data (Vencimento/Recebimento) é obrigatório.', 'error', [{ text: 'OK', class: 'bg-blue-600 hover:bg-blue-700', action: () => this.closeAllModals() }]);
                    return;
                }

                const id = form['transaction-id'].value;
                const amount = parseFloat(form['transaction-amount'].value);
                const installments = parseInt(form['transaction-installments'].value) || 1;
                const baseDueDate = new Date(dueDateValue + 'T12:00:00');
                let propagationStartDate = baseDueDate;

                if (id) {
                    const index = this.state.transactions.findIndex(t => t.id === id);
                    if (index !== -1) { 
                        propagationStartDate = this.state.transactions[index].dueDate; // Usa a data antiga para o início da propagação
                        Object.assign(this.state.transactions[index], { description: form['transaction-description'].value, amount, dueDate: baseDueDate, type: form['transaction-type'].value, status: form['transaction-status'].value }); 
                    }
                } else {
                    const totalAmount = amount, installmentAmount = parseFloat((totalAmount / installments).toFixed(2)), firstInstallmentAmount = totalAmount - (installmentAmount * (installments - 1));
                    const baseTransaction = { description: form['transaction-description'].value, type: form['transaction-type'].value, status: form['transaction-status'].value, shortcutId: form['transaction-shortcut-id'].value || null };
                    const installmentGroupId = crypto.randomUUID();
                    for (let i = 0; i < installments; i++) {
                        const newDate = new Date(baseDueDate); newDate.setMonth(baseDueDate.getMonth() + i);
                        this.state.transactions.push({ ...baseTransaction, id: crypto.randomUUID(), amount: i === 0 ? firstInstallmentAmount : installmentAmount, dueDate: newDate, description: installments > 1 ? `${baseTransaction.description} (${i+1}/${installments})` : baseTransaction.description, installmentGroupId: installments > 1 ? installmentGroupId : null });
                    }
                }
                this.propagateBalanceChanges(propagationStartDate);
                this.saveData(); 
                this.updateUI(); 
                this.closeAllModals();
            },
            
            toggleTransactionStatus(id, isPaid, transactionDate) {
                const transaction = this.state.transactions.find(t => t.id === id);
                if (transaction) {
                    transaction.status = isPaid ? 'paid' : 'pending'; 
                    this.propagateBalanceChanges(transactionDate);
                    this.saveData(); 
                    this.updateUI(); 
                }
            },

            confirmDeleteTransaction(id) {
                const transaction = this.state.transactions.find(t => t.id === id); if (!transaction) return;
                
                if (transaction.installmentGroupId) {
                    this.showMessage(
                        'Excluir Parcela',
                        'Esta transação faz parte de um parcelamento. Como deseja prosseguir?',
                        'warning',
                        [
                            { text: 'Excluir Apenas Esta', class: 'bg-yellow-600 hover:bg-yellow-700', action: () => {
                                const deletedDate = transaction.dueDate;
                                this.state.transactions = this.state.transactions.filter(t => t.id !== id);
                                this.propagateBalanceChanges(deletedDate);
                                this.saveData(); this.updateUI(); this.closeAllModals();
                            }},
                            { text: 'Excluir Esta e Futuras', class: 'bg-red-600 hover:bg-red-700', action: () => {
                                const deletedDate = transaction.dueDate;
                                this.state.transactions = this.state.transactions.filter(t => {
                                    if (t.installmentGroupId !== transaction.installmentGroupId) return true;
                                    return t.dueDate < transaction.dueDate;
                                });
                                this.propagateBalanceChanges(deletedDate);
                                this.saveData(); this.updateUI(); this.closeAllModals();
                            }},
                            { text: 'Cancelar', class: 'bg-gray-700 hover:bg-gray-600', action: () => this.closeAllModals() }
                        ]
                    );
                } else {
                    this.showMessage(
                        'Excluir Transação',
                        `Deseja realmente excluir a transação "${transaction.description}"?`,
                        'warning',
                        [
                            { text: 'Confirmar Exclusão', class: 'bg-red-600 hover:bg-red-700', action: () => {
                                const deletedDate = transaction.dueDate;
                                this.state.transactions = this.state.transactions.filter(t => t.id !== id);
                                this.propagateBalanceChanges(deletedDate);
                                this.saveData(); this.updateUI(); this.closeAllModals();
                            }},
                            { text: 'Cancelar', class: 'bg-gray-700 hover:bg-gray-600', action: () => this.closeAllModals() }
                        ]
                    );
                }
            },
            
             openShortcutModal(id = null) {
                const form = this.elements.shortcutForm;
                form.reset();
                form.elements['shortcut-id'].value = '';
                this.elements.shortcutEffectiveDateSection.classList.add('hidden');
                this.elements.shortcutDueDaySection.classList.add('hidden');
                this.populateIcons();
                lucide.createIcons();

                if(id) { 
                    const shortcut = this.state.shortcuts.find(s => s.id === id); if(!shortcut) return;
                    this.elements.shortcutModalTitle.textContent = 'Editar Atalho';
                    form.elements['shortcut-id'].value = shortcut.id; 
                    form.elements['shortcut-name'].value = shortcut.name; 
                    form.elements['shortcut-type'].value = shortcut.type;
                    form.elements['shortcut-frequency'].value = shortcut.frequency; 
                    form.elements['shortcut-value'].value = shortcut.defaultValue; 
                    form.elements['shortcut-icon'].value = shortcut.icon;
                    const iconBtn = this.elements.iconSelection.querySelector(`[data-icon="${shortcut.icon}"]`);
                    if(iconBtn) iconBtn.classList.add('ring-2', 'ring-blue-500');

                    if (shortcut.frequency === 'fixed') {
                        this.elements.shortcutDueDaySection.classList.remove('hidden');
                        this.elements.shortcutEffectiveDateSection.classList.remove('hidden');
                        form.elements['shortcut-due-day'].value = shortcut.dueDay || 1;
                        form.elements['shortcut-effective-date'].value = this.formatDateForInput(new Date());
                    }

                } else { 
                    this.elements.shortcutModalTitle.textContent = 'Novo Atalho';
                    form.elements['shortcut-due-day'].value = 1; 
                    const firstIcon = this.elements.iconSelection.querySelector('.icon-btn');
                    if(firstIcon) { firstIcon.classList.add('ring-2', 'ring-blue-500'); form.elements['shortcut-icon'].value = firstIcon.dataset.icon; }
                }
                this.openModal('shortcut-modal');
            },

            handleShortcutFormSubmit(e) {
                e.preventDefault();
                const form = e.target.elements;
                const id = form['shortcut-id'].value;
                const shortcutData = { 
                    name: form['shortcut-name'].value, 
                    type: form['shortcut-type'].value, 
                    frequency: form['shortcut-frequency'].value, 
                    defaultValue: parseFloat(form['shortcut-value'].value), 
                    icon: form['shortcut-icon'].value,
                    dueDay: parseInt(form['shortcut-due-day'].value) || 1,
                };
                
                if (id) { 
                    const index = this.state.shortcuts.findIndex(s => s.id === id); if (index === -1) return;
                    const originalShortcut = this.state.shortcuts[index];
                    const isFixedChange = originalShortcut.frequency === 'fixed' && 
                        (originalShortcut.defaultValue !== shortcutData.defaultValue || 
                         originalShortcut.type !== shortcutData.type ||
                         originalShortcut.dueDay !== shortcutData.dueDay);

                    if (isFixedChange) {
                        const effectiveDateValue = form['shortcut-effective-date'].value;
                        if (!effectiveDateValue) {
                            this.showMessage('Data Necessária', 'Por favor, especifique a partir de qual data a alteração deve valer.', 'error', [{text: 'OK', class: 'bg-blue-600', action: () => {}}]);
                            return;
                        }
                        const effectiveDate = new Date(effectiveDateValue + 'T00:00:00');

                        this.showMessage(
                            'Alteração de Atalho Fixo',
                            `As transações pendentes geradas por este atalho a partir de ${effectiveDate.toLocaleDateString('pt-BR')} serão recriadas com os novos dados. Deseja continuar?`,
                            'warning',
                            [
                                { text: 'Confirmar', class: 'bg-blue-600 hover:bg-blue-700', action: () => {
                                    this.state.shortcuts[index] = { ...originalShortcut, ...shortcutData };

                                    this.state.transactions = this.state.transactions.filter(t => 
                                        !(t.shortcutId === id && t.isAutoGenerated && t.status === 'pending' && t.dueDate >= effectiveDate)
                                    );
                                    
                                    this.propagateBalanceChanges(effectiveDate);
                                    this.saveData();
                                    this.updateUI();
                                    this.closeAllModals();
                                }},
                                { text: 'Cancelar', class: 'bg-gray-700 hover:bg-gray-600', action: () => this.closeAllModals() }
                            ]
                        );
                    } else {
                         this.state.shortcuts[index] = { ...originalShortcut, ...shortcutData };
                         this.saveData(); this.updateUI(); this.closeAllModals();
                    }
                } else { 
                    // Usa o início do período atual em vez da data atual para a criação do atalho.
                    const period = this.getPeriod(this.state.currentDateForPeriod);
                    const newShortcut = { id: crypto.randomUUID(), createdAt: period.start, ...shortcutData };
                    this.state.shortcuts.push(newShortcut);
                    this.generateFixedTransactionsForCurrentPeriod();
                    this.saveData(); this.updateUI(); this.closeAllModals();
                }
            },
            
             confirmDeleteShortcut(id) {
                const shortcut = this.state.shortcuts.find(s => s.id === id); if (!shortcut) return;
                const message = shortcut.frequency === 'fixed'
                    ? `Isto também excluirá todas as transações futuras (pendentes) geradas por este atalho. O histórico passado será mantido.`
                    : `As transações existentes não serão afetadas.`;
                
                this.showMessage(
                    'Excluir Atalho',
                    `Deseja realmente excluir o atalho "${shortcut.name}"? ${message}`,
                    'warning',
                    [
                        { text: 'Confirmar Exclusão', class: 'bg-red-600 hover:bg-red-700', action: () => {
                            let propagationDate = new Date();
                            if (shortcut.frequency === 'fixed') {
                                this.state.transactions = this.state.transactions.filter(t => 
                                    !(t.shortcutId === id && t.isAutoGenerated && t.status === 'pending')
                                );
                            }
                            this.state.shortcuts = this.state.shortcuts.filter(s => s.id !== id);
                            this.propagateBalanceChanges(propagationDate);
                            this.saveData(); this.updateUI(); this.closeAllModals();
                        }},
                        { text: 'Cancelar', class: 'bg-gray-700 hover:bg-gray-600', action: () => this.closeAllModals() }
                    ]
                );
            },

            // --- LÓGICA AVANÇADA: TRANSAÇÕES FIXAS E DE SALDO ---
            generateFixedTransactionsForCurrentPeriod() {
                const period = this.getPeriod(this.state.currentDateForPeriod);

                this.state.shortcuts.filter(s => s.frequency === 'fixed').forEach(shortcut => {
                    const dueDay = shortcut.dueDay || 1;
                    const transactionDate = new Date(period.start.getFullYear(), period.start.getMonth(), dueDay);
                    
                    if (shortcut.createdAt) {
                        const creationDate = new Date(shortcut.createdAt);
                        if (transactionDate < new Date(creationDate.getFullYear(), creationDate.getMonth(), 1)) {
                           return; 
                        }
                    }

                    const existing = this.state.transactions.find(t => 
                        t.shortcutId === shortcut.id && 
                        t.dueDate.getFullYear() === transactionDate.getFullYear() &&
                        t.dueDate.getMonth() === transactionDate.getMonth()
                    );

                    if (!existing) {
                        this.state.transactions.push({ 
                            id: crypto.randomUUID(), 
                            description: shortcut.name, 
                            amount: shortcut.defaultValue, 
                            dueDate: transactionDate, 
                            type: shortcut.type, 
                            status: 'pending', 
                            shortcutId: shortcut.id, 
                            isAutoGenerated: true 
                        });
                    }
                });
            },

            updateBalanceTransactionForPeriod(dateForPeriod) {
                const currentPeriod = this.getPeriod(dateForPeriod);
                const prevMonthDate = new Date(currentPeriod.start);
                prevMonthDate.setDate(0); 
                const prevPeriod = this.getPeriod(prevMonthDate);

                // Isso agora inclui a transferência de saldo anterior para encadear corretamente o saldo
                const prevPeriodTransactions = this.state.transactions.filter(t =>
                    t.dueDate >= prevPeriod.start && t.dueDate <= prevPeriod.end
                );
                const received = prevPeriodTransactions.filter(t => t.type === 'revenue' && t.status === 'paid').reduce((sum, t) => sum + t.amount, 0);
                const paid = prevPeriodTransactions.filter(t => t.type === 'expense' && t.status === 'paid').reduce((sum, t) => sum + t.amount, 0);
                const realizedBalance = received - paid;

                const existingTransferIndex = this.state.transactions.findIndex(t =>
                    t.isBalanceTransfer &&
                    t.dueDate.getFullYear() === currentPeriod.start.getFullYear() &&
                    t.dueDate.getMonth() === currentPeriod.start.getMonth()
                );

                const newAmount = Math.abs(realizedBalance);
                const newType = realizedBalance >= 0 ? 'revenue' : 'expense';

                if (existingTransferIndex > -1) {
                    const existingTransfer = this.state.transactions[existingTransferIndex];
                    if (realizedBalance === 0) {
                        this.state.transactions.splice(existingTransferIndex, 1);
                    } else if (existingTransfer.amount !== newAmount || existingTransfer.type !== newType) {
                        existingTransfer.amount = newAmount;
                        existingTransfer.type = newType;
                        existingTransfer.description = `Saldo Mês Anterior (${prevMonthDate.toLocaleDateString('pt-BR', {month: 'long'})})`;
                    }
                } else if (realizedBalance !== 0) {
                    this.state.transactions.push({
                        id: crypto.randomUUID(),
                        description: `Saldo Mês Anterior (${prevMonthDate.toLocaleDateString('pt-BR', {month: 'long'})})`,
                        amount: newAmount,
                        dueDate: currentPeriod.start,
                        type: newType,
                        status: 'paid',
                        isBalanceTransfer: true,
                    });
                }
            },
            
            propagateBalanceChanges(startDate) {
                const today = new Date();
                let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

                // Começa a propagar do próprio mês da mudança
                while (currentDate.getFullYear() < today.getFullYear() || (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() <= today.getMonth())) {
                    this.updateBalanceTransactionForPeriod(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
            },
            
            // --- MÓDULO DE CONSULTORIA ---
            renderClientList() {
                const container = this.elements.clientListContainer;
                if(this.state.clients.length === 0){
                    container.innerHTML = `<div class="text-center py-12 text-gray-500 col-span-full"><i data-lucide="users" class="w-16 h-16 mx-auto mb-4"></i><p>Nenhum cliente cadastrado.</p><p>Clique em "Novo Cliente" para começar.</p></div>`;
                    lucide.createIcons();
                    return;
                }
                container.innerHTML = this.state.clients.map(client => `
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-white">${client.name}</h3>
                            <p class="text-gray-400">${this.formatCurrency(client.rate)} / cabeça</p>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <button class="edit-client-btn flex-1 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors" data-id="${client.id}">Editar</button>
                            <button class="view-slaughters-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" data-id="${client.id}">Visualizar Abates</button>
                        </div>
                    </div>
                `).join('');
            },
            
            renderSlaughterDetail() {
                const client = this.state.clients.find(c => c.id === this.state.currentClientId);
                if (!client) {
                    this.switchView('consultoria-list');
                    return;
                }

                this.elements.slaughterClientName.textContent = client.name;
                this.elements.slaughterClientRate.textContent = `${this.formatCurrency(client.rate)} / cabeça`;

                const container = this.elements.slaughterListContainer;
                const period = this.getPeriod(this.state.currentDateForPeriod);
                const slaughtersInPeriod = this.state.slaughters
                    .filter(s => s.clientId === client.id && s.date >= period.start && s.date <= period.end)
                    .sort((a,b) => b.date - a.date);

                if (slaughtersInPeriod.length === 0) {
                    container.innerHTML = `<div class="text-center py-8 text-gray-500"><i data-lucide="archive" class="w-12 h-12 mx-auto mb-2"></i><p>Nenhum abate registrado para este cliente no período.</p></div>`;
                    lucide.createIcons();
                    return;
                }

                container.innerHTML = `
                    <div class="hidden md:grid grid-cols-5 gap-4 font-bold p-2 text-gray-400 text-sm">
                        <div>Data</div>
                        <div class="text-center">Cabeças</div>
                        <div class="text-right">Receita Total</div>
                        <div class="text-right">Custo Total</div>
                        <div class="text-right">Ações</div>
                    </div>
                    ${slaughtersInPeriod.map(s => {
                        const totalRevenue = (s.heads * client.rate) + (s.revenueTravel || 0);
                        const totalCost = (s.costTravel || 0) + (s.costDaily || 0);
                        return `
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 items-center p-3 rounded-lg hover:bg-gray-700/50 border-b border-gray-700 last:border-b-0">
                                <div>${s.date.toLocaleDateString('pt-BR')}</div>
                                <div class="text-center">${s.heads}</div>
                                <div class="text-right text-green-400">${this.formatCurrency(totalRevenue)}</div>
                                <div class="text-right text-red-400">${this.formatCurrency(totalCost)}</div>
                                <div class="flex justify-end space-x-2">
                                    <button class="edit-slaughter-btn p-2 text-gray-400 hover:text-blue-400 rounded-full hover:bg-gray-600 transition-colors" data-id="${s.id}"><i data-lucide="edit-2" class="w-4 h-4 pointer-events-none"></i></button>
                                    <button class="delete-slaughter-btn p-2 text-gray-400 hover:text-red-400 rounded-full hover:bg-gray-600 transition-colors" data-id="${s.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            },

            openClientModal(id = null) {
                const form = this.elements.clientForm;
                form.reset();
                if(id) {
                    const client = this.state.clients.find(c => c.id === id);
                    if(!client) return;
                    this.elements.clientModalTitle.textContent = 'Editar Cliente';
                    form.elements['client-id'].value = client.id;
                    form.elements['client-name'].value = client.name;
                    form.elements['client-rate'].value = client.rate;
                } else {
                    this.elements.clientModalTitle.textContent = 'Novo Cliente';
                    form.elements['client-id'].value = '';
                }
                this.openModal('client-modal');
            },

            handleClientFormSubmit(e) {
                e.preventDefault();
                const form = e.target.elements;
                const id = form['client-id'].value;
                const clientData = {
                    name: form['client-name'].value,
                    rate: parseFloat(form['client-rate'].value)
                };

                if(id) {
                    const index = this.state.clients.findIndex(c => c.id === id);
                    if(index > -1) {
                        this.state.clients[index] = {...this.state.clients[index], ...clientData};
                    }
                } else {
                    this.state.clients.push({id: crypto.randomUUID(), ...clientData});
                }
                this.saveData();
                this.updateUI();
                this.closeAllModals();
            },
            
            openSlaughterModal(id = null) {
                const form = this.elements.slaughterForm;
                form.reset();
                form.elements['slaughter-client-id'].value = this.state.currentClientId;

                if(id){
                    const slaughter = this.state.slaughters.find(s => s.id === id);
                    if(!slaughter) return;
                    this.elements.slaughterModalTitle.textContent = "Editar Abate";
                    form.elements['slaughter-id'].value = slaughter.id;
                    form.elements['slaughter-date'].value = this.formatDateForInput(slaughter.date);
                    form.elements['slaughter-heads'].value = slaughter.heads;
                    form.elements['slaughter-revenue-travel'].value = slaughter.revenueTravel || '';
                    form.elements['slaughter-cost-travel'].value = slaughter.costTravel || '';
                    form.elements['slaughter-cost-daily'].value = slaughter.costDaily || '';
                } else {
                    this.elements.slaughterModalTitle.textContent = "Novo Abate";
                    form.elements['slaughter-id'].value = '';
                    form.elements['slaughter-date'].value = this.formatDateForInput(new Date());
                }
                this.openModal('slaughter-modal');
            },

            handleSlaughterFormSubmit(e) {
                e.preventDefault();
                const form = e.target.elements;
                const id = form['slaughter-id'].value;
                const clientId = form['slaughter-client-id'].value;
                const client = this.state.clients.find(c => c.id === clientId);
                if(!client) return;

                const slaughterData = {
                    clientId: clientId,
                    date: new Date(form['slaughter-date'].value + "T12:00:00"),
                    heads: parseInt(form['slaughter-heads'].value),
                    revenueTravel: parseFloat(form['slaughter-revenue-travel'].value) || 0,
                    costTravel: parseFloat(form['slaughter-cost-travel'].value) || 0,
                    costDaily: parseFloat(form['slaughter-cost-daily'].value) || 0,
                };
                
                // Remove transações antigas vinculadas se estiver editando
                if(id) {
                    this.state.transactions = this.state.transactions.filter(t => t.slaughterId !== id);
                }
                
                const slaughterId = id || crypto.randomUUID();

                // Cria novas transações vinculadas
                const mainRevenue = slaughterData.heads * client.rate + slaughterData.revenueTravel;
                this.state.transactions.push({
                    id: crypto.randomUUID(),
                    description: `Abate - ${client.name}`,
                    amount: mainRevenue,
                    dueDate: slaughterData.date,
                    type: 'revenue',
                    status: 'pending',
                    slaughterId: slaughterId
                });
                if(slaughterData.costTravel > 0) {
                    this.state.transactions.push({
                        id: crypto.randomUUID(),
                        description: `Custo Deslocamento - ${client.name}`,
                        amount: slaughterData.costTravel,
                        dueDate: slaughterData.date,
                        type: 'expense',
                        status: 'pending',
                        slaughterId: slaughterId
                    });
                }
                 if(slaughterData.costDaily > 0) {
                    this.state.transactions.push({
                        id: crypto.randomUUID(),
                        description: `Custo Diarista - ${client.name}`,
                        amount: slaughterData.costDaily,
                        dueDate: slaughterData.date,
                        type: 'expense',
                        status: 'pending',
                        slaughterId: slaughterId
                    });
                }

                // Salva ou atualiza o abate
                if(id) {
                    const index = this.state.slaughters.findIndex(s => s.id === id);
                    this.state.slaughters[index] = { ...this.state.slaughters[index], ...slaughterData };
                } else {
                    this.state.slaughters.push({id: slaughterId, ...slaughterData});
                }

                this.propagateBalanceChanges(slaughterData.date);
                this.saveData();
                this.updateUI();
                this.closeAllModals();
            },

            confirmDeleteSlaughter(id){
                 this.showMessage(
                    'Excluir Abate',
                    `Deseja realmente excluir este registro de abate? Todas as transações financeiras vinculadas (receitas e despesas) também serão removidas.`,
                    'warning',
                    [
                        { text: 'Confirmar Exclusão', class: 'bg-red-600 hover:bg-red-700', action: () => {
                            const slaughter = this.state.slaughters.find(s => s.id === id);
                            if (slaughter) {
                                const deletedDate = slaughter.date;
                                this.state.slaughters = this.state.slaughters.filter(s => s.id !== id);
                                this.state.transactions = this.state.transactions.filter(t => t.slaughterId !== id);
                                this.propagateBalanceChanges(deletedDate);
                                this.saveData();
                                this.updateUI();
                                this.closeAllModals();
                            }
                        }},
                        { text: 'Cancelar', class: 'bg-gray-700 hover:bg-gray-600', action: () => this.closeAllModals() }
                    ]
                );
            },


            // --- MODAL DE MENSAGEM DINÂMICO ---
            showMessage(title, message, type = 'info', buttons) {
                this.elements.confirmationTitle.textContent = title;
                this.elements.confirmationMessage.innerHTML = message; 
                this.elements.confirmationButtons.innerHTML = '';

                const icons = {
                    warning: { bg: 'bg-yellow-200', text: 'text-yellow-600', icon: 'alert-triangle' },
                    error: { bg: 'bg-red-200', text: 'text-red-600', icon: 'alert-circle' },
                    info: { bg: 'bg-blue-200', text: 'text-blue-600', icon: 'info' }
                };
                const selectedIcon = icons[type] || icons.info;
                this.elements.confirmationIcon.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${selectedIcon.bg} mb-4`;
                this.elements.confirmationIcon.innerHTML = `<i data-lucide="${selectedIcon.icon}" class="h-6 w-6 ${selectedIcon.text}"></i>`;
                
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.textContent = btnInfo.text;
                    button.className = `w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent px-4 py-2 text-base font-medium text-white shadow-sm focus:outline-none ${btnInfo.class}`;
                    button.onclick = btnInfo.action;
                    this.elements.confirmationButtons.appendChild(button);
                });
                
                lucide.createIcons();
                this.openModal('confirmation-modal');
            },

            // --- FUNÇÕES AUXILIARES ---
            formatCurrency(value) { return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); },
            formatDateForInput(date) { const d = new Date(date); let month = '' + (d.getMonth() + 1), day = '' + d.getDate(); if (month.length < 2) month = '0' + month; if (day.length < 2) day = '0' + day; return [d.getFullYear(), month, day].join('-'); },
            populateIcons() {
                this.elements.iconSelection.innerHTML = this.iconList.map(icon => `<button type="button" class="icon-btn p-2 rounded-lg bg-gray-600 hover:bg-gray-500 flex items-center justify-center" data-icon="${icon}"><i data-lucide="${icon}" class="w-6 h-6 pointer-events-none"></i></button>`).join('');
            }
        };

        // Inicia a aplicação quando o DOM estiver pronto
        window.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
